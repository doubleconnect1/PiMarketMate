<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
          if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
              var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
              var firstSheetName = workbook.SheetNames[0];
              var worksheet = workbook.Sheets[firstSheetName];

              // Convert sheet to JSON to filter blank rows
              var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
              // Filter out blank rows (rows where all cells are empty, null, or undefined)
              var filteredData = jsonData.filter(row => row.some(filledCell));

              // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
              var headerRowIndex = filteredData.findIndex((row, index) =>
                row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
              );
              // Fallback
              if (headerRowIndex === -1 || headerRowIndex > 25) {
                headerRowIndex = 0;
              }

              // Convert filtered JSON back to CSV
              var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
              csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
              return csv;
            } catch (e) {
              console.error(e);
              return "";
            }
          }
          return gk_fileData[filename] || "";
        }
</script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pi Market Mate</title>
  <style>
    *,::before,::after{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}::before,::after{--tw-content:''}html,:host{line-height:1.5;-webkit-text-size-adjust:100%;-moz-tab-size:4;tab-size:4;font-family:ui-sans-serif,system-ui,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-feature-settings:normal;font-variation-settings:normal;-webkit-tap-highlight-color:transparent}body{margin:0;line-height:inherit;min-height:100vh;background-color:#f3f4f6;display:flex;justify-content:center;align-items:center}.w-full{width:100%}.max-w-md{max-width:28rem}.border-2{border-width:2px}.border-solid{border-style:solid}.border-dashed{border-style:dashed}.border-gray-300{--tw-border-opacity:1;border-color:rgb(209 213 219 / var(--tw-bg-opacity))}.border-gray-400{--tw-border-opacity:1;border-color:rgb(156 163 175 / var(--tw-border-opacity))}.border-blue-500{--tw-border-opacity:1;border-color:rgb(59 130 246 / var(--tw-border-opacity))}.rounded-md{border-radius:0.375rem}.p-2{padding:0.5rem}.p-4{padding:1rem}.p-6{padding:1.5rem}.px-4{padding-left:1rem;padding-right:1rem}.py-1{padding-top:0.25rem;padding-bottom:0.25rem}.text-center{text-align:center}.text-sm{font-size:0.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.font-medium{font-weight:500}.font-semibold{font-weight:600}.font-bold{font-weight:700}.text-blue-700{--tw-text-opacity:1;color:rgb(29 78 216 / var(--tw-text-opacity))}.text-gray-600{--tw-text-opacity:1;color:rgb(75 85 99 / var(--tw-text-opacity))}.text-gray-700{--tw-text-opacity:1;color:rgb(55 65 81 / var(--tw-text-opacity))}.text-gray-800{--tw-text-opacity:1;color:rgb(31 41 55 / var(--tw-text-opacity))}.text-red-600{--tw-text-opacity:1;color:rgb(220 38 38 / var(--tw-text-opacity))}.text-white{--tw-text-opacity:1;color:rgb(255 255 255 / var(--tw-text-opacity))}.text-green-500{--tw-text-opacity:1;color:rgb(34 197 94 / var(--tw-text-opacity))}.bg-blue-600{--tw-bg-opacity:1;background-color:rgb(37 99 235 / var(--tw-bg-opacity))}.bg-blue-700{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity))}.bg-gray-100{--tw-bg-opacity:1;background-color:rgb(243 244 246 / var(--tw-bg-opacity))}.bg-gray-300{--tw-bg-opacity:1;background-color:rgb(209 213 219 / var(--tw-bg-opacity))}.bg-white{--tw-bg-opacity:1;background-color:rgb(255 255 255 / var(--tw-bg-opacity))}.shadow-lg{--tw-shadow:0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);--tw-shadow-colored:0 10px 15px -3px var(--tw-shadow-color), 0 4px 6px -4px var(--tw-shadow-color);box-shadow:var(--tw-ring-offset-shadow, 0 0 #0000),var(--tw-ring-shadow, 0 0 #0000),var(--tw-shadow)}.hover\:bg-blue-700:hover{--tw-bg-opacity:1;background-color:rgb(29 78 216 / var(--tw-bg-opacity))}.hover\:bg-gray-400:hover{--tw-bg-opacity:1;background-color:rgb(156 163 175 / var(--tw-bg-opacity))}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:ring-2:focus{--tw-ring-offset-shadow:var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);--tw-ring-shadow:var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);box-shadow:var(--tw-ring-offset-shadow),var(--tw-ring-shadow),var(--tw-shadow, 0 0 #0000)}.focus\:ring-blue-500:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(59 130 246 / var(--tw-ring-opacity))}.focus\:ring-gray-300:focus{--tw-ring-opacity:1;--tw-ring-color:rgb(209 213 219 / var(--tw-ring-opacity))}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(0.4, 0, 0.2, 1);transition-duration:150ms}.flex{display:flex}.hidden{display:none}.items-center{align-items:center}.justify-center{justify-content:center}.space-x-4>:not([hidden])~:not([hidden]){--tw-space-x-reverse:0;margin-right:calc(1rem * calc(1 - var(--tw-space-x-reverse)));margin-left:calc(1rem * var(--tw-space-x-reverse))}.mt-1{margin-top:0.25rem}.mt-2{margin-top:0.5rem}.mt-4{margin-top:1rem}.mt-6{margin-top:1.5rem}.mb-2{margin-bottom:0.5rem}.mb-4{margin-bottom:1rem}.block{display:block}.flex-1{flex:1 1 0%}.max-h-40{max-height:10rem}.overflow-y-auto{overflow-y:auto}
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
    #text-viewer {
      display: none;
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border: 2px solid #e5e7eb;
      border-radius: 0.375rem;
      max-height: 70vh;
      overflow-y: auto;
      width: 100%;
      max-width: 28rem;
    }
    #text-content {
      white-space: pre-wrap;
      font-family: 'Courier New', Courier, monospace;
      line-height: 1.4;
      text-align: left;
    }
    #text-fallback {
      color: #dc2626;
      font-size: 0.875rem;
      text-align: center;
      margin-top: 10px;
    }
    .container {
      max-width: 28rem;
      width: 100%;
      padding: 20px;
      text-align: center;
    }
    .content-wrapper {
      width: 100%;
    }
    footer {
      width: 28rem;
      margin: 0 auto;
      text-align: center;
    }
    #donation-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 0.375rem;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
      z-index: 1000;
      width: 90%;
      max-width: 300px;
    }
    #donation-popup.active {
      display: block;
    }
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
    }
    #overlay.active {
      display: block;
    }
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
</head>
<body>
  <div class="container">
    <div class="content-wrapper bg-white p-6 rounded-lg shadow-lg w-full">
      <h1 class="text-2xl font-bold text-center mb-4 flex items-center justify-center">
        <img src="https://raw.githubusercontent.com/doubleconnect1/PiMarketMate/main/assets/pi-logo.png" alt="Pi Network Logo" class="h-5 w-5 mr-2" />
        Pi Market Mate
      </h1>
      <p class="text-center text-gray-600 mb-4">Find out how much Pi you need for a product or service using CoinGecko's official Pi price. Support us with a payment!</p>
      <div class="mb-4">
        <label for="currency" class="block text-sm font-bold text-gray-700">1. SELECT CURRENCY: <span id="currency-check" class="hidden text-green-500">✓</span></label>
        <select
          id="currency"
          class="mt-1 block w-full p-2 border-2 border-solid border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-gray-300"
        >
          <option value="USD">USD (United States)</option>
          <option value="EUR">EUR (Eurozone)</option>
          <option value="JPY">JPY (Japan)</option>
          <option value="GBP">GBP (United Kingdom)</option>
          <option value="CHF">CHF (Switzerland)</option>
          <option value="CAD">CAD (Canada)</option>
          <option value="AUD">AUD (Australia)</option>
          <option value="NZD">NZD (New Zealand)</option>
          <option disabled>──────────</option>
          <option value="AFN">AFN (Afghanistan)</option>
          <option value="ALL">ALL (Albania)</option>
          <option value="DZD">DZD (Algeria)</option>
          <option value="AOA">AOA (Angola)</option>
          <option value="XCD">XCD (Antigua and Barbuda)</option>
          <option value="ARS">ARS (Argentina)</option>
          <option value="AMD">AMD (Armenia)</option>
          <option value="AZN">AZN (Azerbaijan)</option>
          <option value="BSD">BSD (Bahamas)</option>
          <option value="BHD">BHD (Bain)</option>
          <option value="BDT">BDT (Bangladesh)</option>
          <option value="BBD">BBD (Barbados)</option>
          <option value="BYN">BYN (Belarus)</option>
          <option value="BZD">BZD (Belize)</option>
          <option value="XOF">XOF (Benin)</option>
          <option value="BTN">BTN (Bhutan)</option>
          <option value="BOB">BOB (Bolivia)</option>
          <option value="BAM">BAM (Bosnia and Herzegovina)</option>
          <option value="BWP">BWP (Botswana)</option>
          <option value="BRL">BRL (Brazil)</option>
          <option value="BND">BND (Brunei)</option>
          <option value="BGN">BGN (Bulgaria)</option>
          <option value="XOF">XOF (Burkina Faso)</option>
          <option value="BIF">BIF (Burundi)</option>
          <option value="KHR">KHR (Cambodia)</option>
          <option value="XAF">XAF (Cameroon)</option>
          <option value="CVE">CVE (Cape Verde)</option>
          <option value="XAF">XAF (Central African Republic)</option>
          <option value="XAF">XAF (Chad)</option>
          <option value="CLP">CLP (Chile)</option>
          <option value="CNY">CNY (China)</option>
          <option value="COP">COP (Colombia)</option>
          <option value="KMF">KMF (Comoros)</option>
          <option value="CDF">CDF (Congo, Democratic Republic)</option>
          <option value="XAF">XAF (Congo, Republic)</option>
          <option value="CRC">CRC (Costa Rica)</option>
          <option value="HRK">HRK (Croatia)</option>
          <option value="CUP">CUP (Cuba)</option>
          <option value="CZK">CZK (Czech Republic)</option>
          <option value="DKK">DKK (Denmark)</option>
          <option value="DJF">DJF (Djibouti)</option>
          <option value="XCD">XCD (Dominica)</option>
          <option value="DOP">DOP (Dominican Republic)</option>
          <option value="USD">USD (Ecuador)</option>
          <option value="EGP">EGP (Egypt)</option>
          <option value="USD">USD (El Salvador)</option>
          <option value="XAF">XAF (Equatorial Guinea)</option>
          <option value="ERN">ERN (Eritrea)</option>
          <option value="ETB">ETB (Ethiopia)</option>
          <option value="FJD">FJD (Fiji)</option>
          <option value="GMD">GMD (Gambia)</option>
          <option value="GEL">GEL (Georgia)</option>
          <option value="GHS">GHS (Ghana)</option>
          <option value="GTQ">GTQ (Guatemala)</option>
          <option value="GNF">GNF (Guinea)</option>
          <option value="XOF">XOF (Guinea-Bissau)</option>
          <option value="GYD">GYD (Guyana)</option>
          <option value="HTG">HTG (Haiti)</option>
          <option value="HNL">HNL (Honduras)</option>
          <option value="HKD">HKD (Hong Kong)</option>
          <option value="HUF">HUF (Hungary)</option>
          <option value="ISK">ISK (Iceland)</option>
          <option value="INR">INR (India)</option>
          <option value="IDR">IDR (Indonesia)</option>
          <option value="IRR">IRR (Iran)</option>
          <option value="IQD">IQD (Iraq)</option>
          <option value="ILS">ILS (Israel)</option>
          <option value="JMD">JMD (Jamaica)</option>
          <option value="JOD">JOD (Jordan)</option>
          <option value="KZT">KZT (Kazakhstan)</option>
          <option value="KES">KES (Kenya)</option>
          <option value="KWD">KWD (Kuwait)</option>
          <option value="KGS">KGS (Kyrgyzstan)</option>
          <option value="LAK">LAK (Laos)</option>
          <option value="LBP">LBP (Lebanon)</option>
          <option value="LSL">LSL (Lesotho)</option>
          <option value="LRD">LRD (Liberia)</option>
          <option value="LYD">LYD (Libya)</option>
          <option value="MGA">MGA (Madagascar)</option>
          <option value="MWK">MWK (Malawi)</option>
          <option value="MYR">MYR (Malaysia)</option>
          <option value="MVR">MVR (Maldives)</option>
          <option value="XOF">XOF (Mali)</option>
          <option value="USD">USD (Marshall Islands)</option>
          <option value="MRO">MRO (Mauritania)</option>
          <option value="MUR">MUR (Mauritius)</option>
          <option value="MXN">MXN (Mexico)</option>
          <option value="USD">USD (Micronesia)</option>
          <option value="MDL">MDL (Moldova)</option>
          <option value="MNT">MNT (Mongolia)</option>
          <option value="MAD">MAD (Morocco)</option>
          <option value="MZN">MZN (Mozambique)</option>
          <option value="MMK">MMK (Myanmar)</option>
          <option value="NAD">NAD (Namibia)</option>
          <option value="AUD">AUD (Nauru)</option>
          <option value="NPR">NPR (Nepal)</option>
          <option value="NIO">NIO (Nicaragua)</option>
          <option value="XOF">XOF (Niger)</option>
          <option value="NGN">NGN (Nigeria)</option>
          <option value="MKD">MKD (North Macedonia)</option>
          <option value="NOK">NOK (Norway)</option>
          <option value="OMR">OMR (Oman)</option>
          <option value="PKR">PKR (Pakistan)</option>
          <option value="USD">USD (Palau)</option>
          <option value="ILS">ILS (Palestine)</option>
          <option value="USD">USD (Panama)</option>
          <option value="PGK">PGK (Papua New Guinea)</option>
          <option value="PYG">PYG (Paraguay)</option>
          <option value="PEN">PEN (Peru)</option>
          <option value="PHP">PHP (Philippines)</option>
          <option value="PLN">PLN (Poland)</option>
          <option value="QAR">QAR (Qatar)</option>
          <option value="RON">RON (Romania)</option>
          <option value="RUB">RUB (Russia)</option>
          <option value="RWF">RWF (Rwanda)</option>
          <option value="XCD">XCD (Saint Kitts and Nevis)</option>
          <option value="XCD">XCD (Saint Lucia)</option>
          <option value="XCD">XCD (Saint Vincent and the Grenadines)</option>
          <option value="WST">WST (Samoa)</option>
          <option value="STD">STD (Sao Tome and Principe)</option>
          <option value="SAR">SAR (Saudi Arabia)</option>
          <option value="XOF">XOF (Senegal)</option>
          <option value="RSD">RSD (Serbia)</option>
          <option value="SCR">SCR (Seychelles)</option>
          <option value="SLL">SLL (Sierra Leone)</option>
          <option value="SGD">SGD (Singapore)</option>
          <option value="SBD">SBD (Solomon Islands)</option>
          <option value="SOS">SOS (Somalia)</option>
          <option value="ZAR">ZAR (South Africa)</option>
          <option value="KRW">KRW (South Korea)</option>
          <option value="SSP">SSP (South Sudan)</option>
          <option value="LKR">LKR (Sri Lanka)</option>
          <option value="SDG">SDG (Sudan)</option>
          <option value="SRD">SRD (Suriname)</option>
          <option value="SEK">SEK (Sweden)</option>
          <option value="SYP">SYP (Syria)</option>
          <option value="TWD">TWD (Taiwan)</option>
          <option value="TJS">TJS (Tajikistan)</option>
          <option value="TZS">TZS (Tanzania)</option>
          <option value="THB">THB (Thailand)</option>
          <option value="USD">USD (Timor-Leste)</option>
          <option value="XOF">XOF (Togo)</option>
          <option value="TOP">TOP (Tonga)</option>
          <option value="TTD">TTD (Trinidad and Tobago)</option>
          <option value="TND">TND (Tunisia)</option>
          <option value="TRY">TRY (Turkey)</option>
          <option value="TMT">TMT (Turkmenistan)</option>
          <option value="AUD">AUD (Tuvalu)</option>
          <option value="UGX">UGX (Uganda)</option>
          <option value="UAH">UAH (Ukraine)</option>
          <option value="AED">AED (United Arab Emirates)</option>
          <option value="UYU">UYU (Uruguay)</option>
          <option value="UZS">UZS (Uzbekistan)</option>
          <option value="VUV">VUV (Vanuatu)</option>
          <option value="VEF">VEF (Venezuela)</option>
          <option value="VND">VND (Vietnam)</option>
          <option value="YER">YER (Yemen)</option>
          <option value="ZMW">ZMW (Zambia)</option>
          <option value="ZWL">ZWL (Zimbabwe)</option>
        </select>
      </div>
      <div id="price-display" class="text-center mb-4">
        <p>Current Pi Price: <span id="pi-price" class="font-semibold">Fetching...</span></p>
      </div>
      <div class="mb-4">
        <label class="block text-sm font-bold text-gray-700">Calculation Mode:</label>
        <div class="flex justify-center space-x-4">
          <button
            id="usd-to-pi-btn"
            class="flex-1 bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition"
          >
            Currency to Pi
          </button>
          <button
            id="pi-to-usd-btn"
            class="flex-1 bg-gray-300 text-gray-700 p-2 rounded-md hover:bg-gray-400 transition"
          >
            Pi to Currency
          </button>
        </div>
      </div>
      <div class="mb-4">
        <label id="input-label" for="amount" class="block text-sm font-bold text-gray-700"><span id="input-label-text">2. ENTER AMOUNT (USD):</span> <span id="amount-check" class="hidden text-green-500">✓</span></label>
        <input
          type="number"
          id="amount"
          step="0.01"
          min="0"
          placeholder="e.g., 10000"
          class="mt-1 block w-full p-2 border-2 border-solid border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-gray-300"
        />
      </div>
      <button
        id="calculate-btn"
        class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition"
      >
        Calculate
      </button>
      <div class="mt-4 mb-4 bg-gray-100 p-4 rounded-md border-dashed border-2 border-gray-400">
        <label for="manual-price" class="block text-sm font-bold text-gray-700">Manual Pi Price (Offline or Unsupported Currencies):</label>
        <input
          type="number"
          id="manual-price"
          step="0.0001"
          min="0"
          placeholder="Enter Pi price (e.g., 0.123)"
          class="mt-1 block w-full p-2 border-2 border-solid border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-gray-300"
        />
      </div>
      <div id="result" class="mt-6 text-center hidden bg-blue-100 p-4 rounded-md border-2 border-blue-500 animate-fadeIn">
        <p class="text-2xl font-bold text-gray-800">
          <span id="result-text-prefix"></span>
          <span id="result-value" class="text-blue-700"></span>
        </p>
        <button
          id="pay-with-pi-btn"
          class="mt-4 w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition"
        >
          Pay with Pi
        </button>
      </div>
      <div id="error" class="mt-4 text-center text-red-600 hidden">
        <p id="error-message"></p>
      </div>
      <div class="mt-6">
        <h2 class="text-lg font-semibold text-center mb-2">Recent Calculations</h2>
        <ul id="recent-calculations" class="text-sm text-gray-600 max-h-40 overflow-y-auto"></ul>
      </div>
    </div>
    <footer class="mt-6 text-center text-sm text-gray-600">
      <a href="#" id="privacy-policy-link" class="text-blue-600 hover:underline">Privacy Policy</a> |
      <a href="#" id="terms-of-service-link" class="text-blue-600 hover:underline">Terms of Service</a> |
      <a href="#" id="donation-link" class="text-blue-600 hover:underline">Donation to Pi Market Mate</a>
    </footer>
    <div id="text-viewer">
      <button id="close-text" class="bg-red-600 text-white p-2 rounded-md hover:bg-red-700 transition">Close</button>
      <div id="text-content"></div>
      <p id="text-fallback" class="hidden">Failed to load the text content. <a id="text-download-link" href="#" class="text-blue-600 hover:underline">Download the file</a> instead.</p>
    </div>
    <div id="overlay"></div>
    <div id="donation-popup">
      <h3 class="text-lg font-semibold mb-2">Select Donation Amount</h3>
      <select id="donation-amount-select" class="w-full p-2 border-2 border-gray-300 rounded-md mb-4">
        <option value="1">1 Pi</option>
        <option value="2">2 Pi</option>
        <option value="3">3 Pi</option>
        <option value="4">4 Pi</option>
        <option value="5">5 Pi</option>
        <option value="10">10 Pi</option>
        <option value="20">20 Pi</option>
        <option value="30">30 Pi</option>
      </select>
      <button id="confirm-donation" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700 transition">Confirm</button>
      <button id="cancel-donation" class="mt-2 w-full bg-gray-300 text-gray-700 p-2 rounded-md hover:bg-gray-400 transition">Cancel</button>
    </div>
  </div>
  <script>
    let currentMode = 'usd-to-pi';
    let lastPiPrices = {
      AFN: null, ALL: null, DZD: null, EUR: null, AOA: null, XCD: null, ARS: null, AMD: null, AUD: null, AZN: null,
      BSD: null, BHD: null, BDT: null, BBD: null, BYN: null, BZD: null, XOF: null, BTN: null, BOB: null, BAM: null,
      BWP: null, BRL: null, BND: null, BGN: null, BIF: null, KHR: null, XAF: null, CAD: null, CVE: null, CLP: null,
      CNY: null, COP: null, KMF: null, CDF: null, CRC: null, HRK: null, CUP: null, CZK: null, DKK: null, DJF: null,
      DOP: null, USD: null, EGP: null, ERN: null, ETB: null, FJD: null, GMD: null, GEL: null, GHS: null, GTQ: null,
      GNF: null, GYD: null, HTG: null, HNL: null, HKD: null, HUF: null, ISK: null, INR: null, IDR: null, IRR: null,
      IQD: null, ILS: null, JMD: null, JPY: null, JOD: null, KZT: null, KES: null, KRW: null, KWD: null, KGS: null,
      LAK: null, LBP: null, LSL: null, LRD: null, LYD: null, CHF: null, MGA: null, MWK: null, MYR: null, MVR: null,
      MRO: null, MUR: null, MXN: null, MDL: null, MNT: null, MAD: null, MZN: null, MMK: null, NAD: null, NPR: null,
      NZD: null, NIO: null, NGN: null, MKD: null, NOK: null, OMR: null, PKR: null, PGK: null, PYG: null, PEN: null,
      PHP: null, PLN: null, QAR: null, RON: null, RUB: null, RWF: null, STD: null, SAR: null, RSD: null, SCR: null,
      SLL: null, SGD: null, SBD: null, SOS: null, ZAR: null, SSP: null, LKR: null, SDG: null, SRD: null, SEK: null,
      SYP: null, TWD: null, TJS: null, TZS: null, THB: null, TOP: null, TTD: null, TND: null, TRY: null, TMT: null,
      VUV: null, UGX: null, UAH: null, AED: null, GBP: null, UYU: null, UZS: null, VEF: null, VND: null, YER: null,
      ZMW: null, ZWL: null
    };
    let currentCurrency = localStorage.getItem('piMarketMateCurrency') || 'USD';
    let lastCalculatedPiAmount = null;
    let recentCalculations = JSON.parse(localStorage.getItem('piMarketMateCalculations')) || [];

    // Initialize Pi SDK
    let Pi;
    try {
      Pi = window.Pi;
      if (!Pi) {
        throw new Error("Pi SDK not found");
      }
      Pi.init({ version: "2.0", sandbox: false });
      alert("Pi SDK initialized successfully");
      if (!Pi.isReady) {
        alert("Pi SDK not ready yet");
      }
    } catch (error) {
      alert("Failed to initialize Pi SDK: " + error.message);
    }

    // Function to check user login status
    async function checkUserLogin() {
      return new Promise((resolve, reject) => {
        if (typeof Pi.getUserInfo !== 'function') {
          alert("Pi.getUserInfo not available in SDK");
          resolve(false);
          return;
        }
        alert("Checking user login status...");
        const timeout = setTimeout(() => {
          alert("User login check timed out after 5 seconds");
          reject(new Error("User login check timed out"));
        }, 5000);

        Pi.getUserInfo(
          (userInfo) => {
            clearTimeout(timeout);
            if (userInfo && userInfo.uid) {
              alert("User is logged in: " + userInfo.uid);
              resolve(true);
            } else {
              alert("User is not logged in");
              resolve(false);
            }
          },
          (error) => {
            clearTimeout(timeout);
            alert("Failed to check user login: " + (error.message || 'Unknown error'));
            reject(error);
          }
        );
      });
    }

    // Function to retry SDK initialization
    async function ensurePiSDKReady(maxRetries = 5, delayMs = 3000, timeoutMs = 20000) {
      return new Promise((resolve, reject) => {
        if (Pi.isReady) {
          alert("Pi SDK is ready on initial check");
          resolve(true);
          return;
        }

        let retries = 0;
        let hasResolved = false;

        // Listen for SDK ready event
        if (typeof Pi.onReady === 'function') {
          alert("Listening for Pi SDK ready event");
          Pi.onReady(() => {
            if (!hasResolved) {
              hasResolved = true;
              alert("Pi SDK ready event triggered");
              resolve(true);
            }
          });
        } else {
          alert("Pi SDK ready event listener not available");
        }

        // Retry loop
        const retryInterval = setInterval(async () => {
          if (Pi.isReady) {
            if (!hasResolved) {
              hasResolved = true;
              clearInterval(retryInterval);
              clearTimeout(timeoutTimer);
              alert("Pi SDK is ready after " + retries + " retries");
              resolve(true);
            }
            return;
          }

          if (retries >= maxRetries) {
            clearInterval(retryInterval);
            clearTimeout(timeoutTimer);
            if (!hasResolved) {
              hasResolved = true;
              alert("Failed to initialize Pi SDK after " + maxRetries + " retries");
              reject(new Error("Pi SDK not ready after maximum retries"));
            }
            return;
          }

          alert("Pi SDK not ready, retrying (" + (retries + 1) + "/" + maxRetries + ")...");
          try {
            // Alternate between sandbox true/false to try different configurations
            const sandboxMode = retries % 2 === 0;
            Pi.init({ version: "2.0", sandbox: sandboxMode });
            alert("Retried with sandbox: " + sandboxMode);
          } catch (error) {
            alert("Retry " + (retries + 1) + " failed: " + error.message);
          }
          retries++;
        }, delayMs);

        // Timeout for the entire process
        const timeoutTimer = setTimeout(() => {
          if (!hasResolved) {
            hasResolved = true;
            clearInterval(retryInterval);
            alert("Pi SDK initialization timed out after " + timeoutMs + "ms");
            reject(new Error("Pi SDK initialization timed out"));
          }
        }, timeoutMs);
      });
    }

    // Check Pi Network server availability
    async function checkPiServer() {
      try {
        const response = await fetch('https://api.minepi.com/v1/health', { method: 'HEAD', timeout: 5000 });
        alert("Pi Network server ping: " + (response.ok ? "Success" : "Failed, status: " + response.status));
        return response.ok;
      } catch (error) {
        alert("Pi Network server ping failed: " + error.message);
        return false;
      }
    }

    async function fetchPiPrice(currency) {
      try {
        const response = await fetch(
          `https://api.coingecko.com/api/v3/simple/price?ids=pi-network&vs_currencies=${currency.toLowerCase()}`
        );
        if (!response.ok) {
          throw new Error('Failed to fetch Pi price');
        }
        const data = await response.json();
        if (!data['pi-network'][currency.toLowerCase()]) {
          throw new Error('Currency not supported by CoinGecko');
        }
        const piPrice = data['pi-network'][currency.toLowerCase()];
        lastPiPrices[currency] = piPrice;
        return piPrice;
      } catch (error) {
        throw error;
      }
    }
    async function updatePiPrice() {
      const manualPriceInput = document.getElementById('manual-price');
      try {
        const piPrice = await fetchPiPrice(currentCurrency);
        document.getElementById('pi-price').textContent = `${currentCurrency} ${piPrice.toFixed(4)}`;
        manualPriceInput.value = piPrice.toFixed(4);
      } catch (error) {
        document.getElementById('pi-price').textContent = 'Unavailable';
        if (lastPiPrices[currentCurrency]) {
          manualPriceInput.value = lastPiPrices[currentCurrency].toFixed(4);
        }
        showError('Pi price unavailable. Enter a manual price below.');
      }
    }
    function getEffectivePiPrice() {
      const manualPrice = parseFloat(document.getElementById('manual-price').value);
      if (!isNaN(manualPrice) && manualPrice > 0) {
        return manualPrice;
      }
      return lastPiPrices[currentCurrency];
    }
    function calculateAmount(amount, piPrice) {
      if (isNaN(amount) || amount <= 0) {
        showError(`Please enter a valid ${currentMode === 'usd-to-pi' ? currentCurrency : 'Pi'} amount.`);
        return null;
      }
      if (isNaN(piPrice) || piPrice <= 0) {
        showError('Pi price is unavailable. Enter a manual price below.');
        return null;
      }
      if (currentMode === 'usd-to-pi') {
        return (amount / piPrice).toFixed(2);
      } else {
        return (amount * piPrice).toFixed(2);
      }
    }
    function saveCalculation(input, result, paid = false) {
      const calculation = {
        mode: currentMode,
        currency: currentCurrency,
        input: parseFloat(input).toFixed(2),
        result: parseFloat(result).toFixed(2),
        timestamp: new Date().toLocaleString(),
        paid: paid
      };
      recentCalculations.unshift(calculation);
      recentCalculations = recentCalculations.slice(0, 5);
      localStorage.setItem('piMarketMateCalculations', JSON.stringify(recentCalculations));
      updateRecentCalculations();
    }
    function updateRecentCalculations() {
      const list = document.getElementById('recent-calculations');
      list.innerHTML = '';
      recentCalculations.forEach(calc => {
        const li = document.createElement('li');
        li.className = 'py-1';
        if (calc.mode === 'usd-to-pi') {
          li.textContent = `${calc.timestamp}: ${calc.input} ${calc.currency} = ${calc.result} Pi${calc.paid ? ' (Paid)' : ''}`;
        } else {
          li.textContent = `${calc.timestamp}: ${calc.input} Pi = ${calc.result} ${calc.currency}${calc.paid ? ' (Paid)' : ''}`;
        }
        list.appendChild(li);
      });
    }
    function showError(message) {
      const errorDiv = document.getElementById('error');
      const errorMessage = document.getElementById('error-message');
      if (errorDiv && errorMessage) {
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
        document.getElementById('result').classList.add('hidden');
      }
      alert("Error: " + message);
    }
    function clearError() {
      const errorDiv = document.getElementById('error');
      if (errorDiv) {
        errorDiv.classList.add('hidden');
      }
    }
    function setMode(mode) {
      currentMode = mode;
      const usdToPiBtn = document.getElementById('usd-to-pi-btn');
      const piToUsdBtn = document.getElementById('pi-to-usd-btn');
      const inputLabelText = document.getElementById('input-label-text');
      const amountCheck = document.getElementById('amount-check');
      if (usdToPiBtn && piToUsdBtn && inputLabelText && amountCheck) {
        if (mode === 'usd-to-pi') {
          usdToPiBtn.classList.remove('bg-gray-300', 'text-gray-700');
          usdToPiBtn.classList.add('bg-blue-600', 'text-white');
          piToUsdBtn.classList.remove('bg-blue-600', 'text-white');
          piToUsdBtn.classList.add('bg-gray-300', 'text-gray-700');
          inputLabelText.textContent = `2. ENTER AMOUNT (${currentCurrency}):`;
        } else {
          piToUsdBtn.classList.remove('bg-gray-300', 'text-gray-700');
          piToUsdBtn.classList.add('bg-blue-600', 'text-white');
          usdToPiBtn.classList.remove('bg-blue-600', 'text-white');
          usdToPiBtn.classList.add('bg-gray-300', 'text-gray-700');
          inputLabelText.textContent = '2. ENTER AMOUNT (PI):';
        }
        document.getElementById('amount').value = '';
        amountCheck.classList.add('hidden');
        document.getElementById('result').classList.add('hidden');
      }
    }
    function isPiBrowser() {
      const hostname = window.location.hostname.toLowerCase();
      const isPi = hostname.includes('pimarketmate.com') || hostname.includes('marketmate') || hostname.includes('pinet.com');
      alert("Pi Browser check: Yes");
      return isPi;
    }
    const usdToPiBtn = document.getElementById('usd-to-pi-btn');
    if (usdToPiBtn) {
      usdToPiBtn.addEventListener('click', () => setMode('usd-to-pi'));
      usdToPiBtn.addEventListener('touchstart', () => setMode('usd-to-pi'));
    }
    const piToUsdBtn = document.getElementById('pi-to-usd-btn');
    if (piToUsdBtn) {
      piToUsdBtn.addEventListener('click', () => setMode('pi-to-usd'));
      piToUsdBtn.addEventListener('touchstart', () => setMode('pi-to-usd'));
    }
    const currencySelect = document.getElementById('currency');
    const currencyCheck = document.getElementById('currency-check');
    if (currencySelect && currencyCheck) {
      currencySelect.value = currentCurrency;
      currencyCheck.classList.remove('hidden');
      currencySelect.addEventListener('change', (e) => {
        const selectedCurrency = e.target.value.toUpperCase();
        if (lastPiPrices.hasOwnProperty(selectedCurrency)) {
          currentCurrency = selectedCurrency;
          localStorage.setItem('piMarketMateCurrency', selectedCurrency);
          document.getElementById('input-label-text').textContent = 
            currentMode === 'usd-to-pi' ? 
            `2. ENTER AMOUNT (${currentCurrency}):` : 
            '2. ENTER AMOUNT (PI):';
          currencyCheck.classList.remove('hidden');
          updatePiPrice();
        } else {
          currencyCheck.classList.add('hidden');
        }
      });
    }
    const amountInput = document.getElementById('amount');
    const amountCheck = document.getElementById('amount-check');
    if (amountInput && amountCheck) {
      amountInput.addEventListener('input', (e) => {
        const amount = parseFloat(e.target.value);
        if (!isNaN(amount) && amount > 0) {
          amountCheck.classList.remove('hidden');
        } else {
          amountCheck.classList.add('hidden');
        }
      });
    }
    const calculateBtn = document.getElementById('calculate-btn');
    if (calculateBtn) {
      calculateBtn.addEventListener('click', async () => {
        clearError();
        const amount = parseFloat(document.getElementById('amount').value);
        try {
          let piPrice = getEffectivePiPrice();
          if (!piPrice) {
            await fetchPiPrice(currentCurrency);
            piPrice = getEffectivePiPrice();
          }
          const result = calculateAmount(amount, piPrice);
          if (result) {
            const prefix = currentMode === 'usd-to-pi' ? 'You need: ' : 'You get: ';
            const value = currentMode === 'usd-to-pi' ? `${result} Pi` : `${result} ${currentCurrency}`;
            const resultTextPrefix = document.getElementById('result-text-prefix');
            const resultValue = document.getElementById('result-value');
            const resultDiv = document.getElementById('result');
            if (resultTextPrefix && resultValue && resultDiv) {
              resultTextPrefix.textContent = prefix;
              resultValue.textContent = value;
              resultDiv.classList.remove('hidden');
              if (currentMode === 'usd-to-pi') {
                lastCalculatedPiAmount = parseFloat(result);
              }
            }
            saveCalculation(amount, result);
          }
        } catch (error) {
          showError('Pi price unavailable. Enter a manual price below.');
        }
      });
      calculateBtn.addEventListener('touchstart', async () => {
        clearError();
        const amount = parseFloat(document.getElementById('amount').value);
        try {
          let piPrice = getEffectivePiPrice();
          if (!piPrice) {
            await fetchPiPrice(currentCurrency);
            piPrice = getEffectivePiPrice();
          }
          const result = calculateAmount(amount, piPrice);
          if (result) {
            const prefix = currentMode === 'usd-to-pi' ? 'You need: ' : 'You get: ';
            const value = currentMode === 'usd-to-pi' ? `${result} Pi` : `${result} ${currentCurrency}`;
            const resultTextPrefix = document.getElementById('result-text-prefix');
            const resultValue = document.getElementById('result-value');
            const resultDiv = document.getElementById('result');
            if (resultTextPrefix && resultValue && resultDiv) {
              resultTextPrefix.textContent = prefix;
              resultValue.textContent = value;
              resultDiv.classList.remove('hidden');
              if (currentMode === 'usd-to-pi') {
                lastCalculatedPiAmount = parseFloat(result);
              }
            }
            saveCalculation(amount, result);
          }
        } catch (error) {
          showError('Pi price unavailable. Enter a manual price below.');
        }
      });
    }

    const payWithPiBtn = document.getElementById('pay-with-pi-btn');
    if (payWithPiBtn) {
      payWithPiBtn.addEventListener('click', () => {
        if (!isPiBrowser()) {
          showError('Please open this app in Pi Browser to make a payment.');
          return;
        }
        if (currentMode !== 'usd-to-pi' || !lastCalculatedPiAmount) {
          showError('Please calculate a Pi amount first using "Currency to Pi" mode.');
          return;
        }
        initiatePayment(lastCalculatedPiAmount, 'Payment for calculated amount via Pi Market Mate', { app: 'Pi Market Mate', type: 'calculated_payment' });
      });
      payWithPiBtn.addEventListener('touchstart', () => {
        if (!isPiBrowser()) {
          showError('Please open this app in Pi Browser to make a payment.');
          return;
        }
        if (currentMode !== 'usd-to-pi' || !lastCalculatedPiAmount) {
          showError('Please calculate a Pi amount first using "Currency to Pi" mode.');
          return;
        }
        initiatePayment(lastCalculatedPiAmount, 'Payment for calculated amount via Pi Market Mate', { app: 'Pi Market Mate', type: 'calculated_payment' });
      });
    }

    async function initiatePayment(amount, memo, metadata) {
      try {
        if (!isPiBrowser()) {
          showError('Please open this app in Pi Browser to make a payment.');
          return;
        }

        if (!Pi) {
          showError("Pi SDK is not available. Please ensure you're in the Pi Browser.");
          return;
        }

        // Check user login status
        try {
          const isLoggedIn = await checkUserLogin();
          if (!isLoggedIn) {
            showError("User not logged in. Please log in to Pi Browser and try again.");
            return;
          }
        } catch (error) {
          showError("Failed to verify user login status: " + error.message);
          return;
        }

        // Ensure SDK is ready with retries
        try {
          const isReady = await ensurePiSDKReady();
          if (!isReady) {
            throw new Error("Pi SDK failed to become ready");
          }
        } catch (error) {
          showError("Pi SDK failed to become ready after retries. Please restart Pi Browser and ensure you're logged in.");
          return;
        }

        // Ping Pi Network server
        alert("Checking Pi Network server availability...");
        const serverAvailable = await checkPiServer();
        if (!serverAvailable) {
          showError('Pi Network servers appear unavailable. Please try again later.');
          return;
        }

        alert("Initiating payment for " + amount + " Pi...");
        const payment = await Pi.createPayment({
          amount: amount,
          memo: memo,
          metadata: metadata
        });

        payment.then(async (paymentResult) => {
          alert("Payment approved by user, paymentId: " + paymentResult.identifier);
          // Simulate sending to backend
          await simulateSendToBackend(paymentResult.identifier);
        }).catch((error) => {
          alert("Payment failed: " + (error.message || 'Unknown error'));
          if (error.message.includes("User cancelled")) {
            showError('Payment cancelled by user.');
          } else if (error.message.includes("Insufficient balance")) {
            showError('Insufficient Pi balance to complete the payment.');
          } else {
            showError('Payment failed: ' + (error.message || 'Unknown error'));
          }
        });
      } catch (error) {
        alert("Error in initiatePayment: " + error.message);
        showError('An error occurred during payment: ' + error.message);
      }
    }

    // Simulate backend verification and completion
    async function simulateSendToBackend(paymentId) {
      try {
        alert("Simulating backend verification for paymentId: " + paymentId);
        const status = await simulateVerifyPayment(paymentId);
        if (status === 'pending') {
          alert("Payment is pending, simulating completion...");
          await simulateCompletePayment(paymentId);
        } else if (status === 'completed') {
          alert("Payment already completed");
          showError('Payment successful! Transaction completed.');
        } else {
          alert("Payment status: " + status);
          showError('Payment ' + status + '.');
        }
      } catch (error) {
        alert("Backend simulation failed: " + error.message);
        showError('Failed to verify/complete payment: ' + error.message);
      }
    }

    async function simulateVerifyPayment(paymentId) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve('pending'); // Simulate pending status
        }, 1000);
      });
    }

    async function simulateCompletePayment(paymentId) {
      return new Promise((resolve) => {
        setTimeout(() => {
          const txid = 'TX' + Math.random().toString(36).substr(2, 9);
          alert("Payment completed with txid: " + txid);
          saveCalculation(paymentId, paymentId, true);
          showError('Payment successful! Transaction ID: ' + txid);
          resolve(txid);
        }, 1000);
      });
    }

    const donationLink = document.getElementById('donation-link');
    const donationPopup = document.getElementById('donation-popup');
    const overlay = document.getElementById('overlay');
    const confirmDonationBtn = document.getElementById('confirm-donation');
    const cancelDonationBtn = document.getElementById('cancel-donation');
    const donationAmountSelect = document.getElementById('donation-amount-select');

    if (donationLink) {
      donationLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (!isPiBrowser()) {
          showError('Please open this app in Pi Browser to make a donation.');
          return;
        }
        donationPopup.classList.add('active');
        overlay.classList.add('active');
      });
      donationLink.addEventListener('touchstart', (e) => {
        e.preventDefault();
        if (!isPiBrowser()) {
          showError('Please open this app in Pi Browser to make a donation.');
          return;
        }
        donationPopup.classList.add('active');
        overlay.classList.add('active');
      });
    }

    if (confirmDonationBtn) {
      confirmDonationBtn.addEventListener('click', async () => {
        const selectedAmount = parseFloat(donationAmountSelect.value);
        if (isNaN(selectedAmount) || selectedAmount <= 0) {
          showError('Please select a valid donation amount.');
          return;
        }
        donationPopup.classList.remove('active');
        overlay.classList.remove('active');
        initiatePayment(selectedAmount, 'Donation to Pi Market Mate', { app: 'Pi Market Mate', subdomain: 'marketmate5838', walletAddress: 'GA4QWW7FATZUF4QYGMKK3NXMTDVDXWVD6U36UZJJWUHKO7GQ6AU5MMGP' });
      });
      confirmDonationBtn.addEventListener('touchstart', async () => {
        const selectedAmount = parseFloat(donationAmountSelect.value);
        if (isNaN(selectedAmount) || selectedAmount <= 0) {
          showError('Please select a valid donation amount.');
          return;
        }
        donationPopup.classList.remove('active');
        overlay.classList.remove('active');
        initiatePayment(selectedAmount, 'Donation to Pi Market Mate', { app: 'Pi Market Mate', subdomain: 'marketmate5838', walletAddress: 'GA4QWW7FATZUF4QYGMKK3NXMTDVDXWVD6U36UZJJWUHKO7GQ6AU5MMGP' });
      });
    }

    if (cancelDonationBtn) {
      cancelDonationBtn.addEventListener('click', () => {
        donationPopup.classList.remove('active');
        overlay.classList.remove('active');
      });
      cancelDonationBtn.addEventListener('touchstart', () => {
        donationPopup.classList.remove('active');
        overlay.classList.remove('active');
      });
    }

    setMode('usd-to-pi');
    updatePiPrice();
    updateRecentCalculations();

    // Text Viewer Functionality
    const privacyPolicyLink = document.getElementById('privacy-policy-link');
    const termsOfServiceLink = document.getElementById('terms-of-service-link');
    const textViewer = document.getElementById('text-viewer');
    const textContent = document.getElementById('text-content');
    const textFallback = document.getElementById('text-fallback');
    const textDownloadLink = document.getElementById('text-download-link');
    const closeTextBtn = document.getElementById('close-text');

    async function displayText(url, title) {
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Failed to fetch ${title} (${response.status} ${response.statusText})`);
        }
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('text/plain')) {
          throw new Error(`Unexpected content type for ${title}: ${contentType || 'none'}`);
        }
        const text = await response.text();
        if (!text || text.trim() === '') {
          throw new Error(`${title} file is empty`);
        }
        textContent.textContent = text;
        textViewer.style.display = 'block';
        textFallback.classList.add('hidden');
        textDownloadLink.href = url;
      } catch (error) {
        let fallbackMessage = 'Failed to load the content. ';
        if (error.message.includes('Failed to fetch')) {
          fallbackMessage += `${title} may be missing or inaccessible. `;
        } else if (error.message.includes('Unexpected content type')) {
          fallbackMessage += `The server returned an invalid content type. `;
        } else if (error.message.includes('file is empty')) {
          fallbackMessage += `The ${title} file is empty. `;
        }
        fallbackMessage += `Please try again later or <a id="text-download-link" href="${url}" class="text-blue-600 hover:underline">download the file</a>.`;
        textContent.textContent = '';
        textFallback.innerHTML = fallbackMessage;
        textFallback.classList.remove('hidden');
      }
      textViewer.scrollIntoView({ behavior: 'smooth' });
    }

    if (privacyPolicyLink) {
      privacyPolicyLink.addEventListener('click', (e) => {
        e.preventDefault();
        const privacyPolicyUrl = 'https://raw.githubusercontent.com/doubleconnect1/PiMarketMate/main/docs/PrivacyPolicy.txt';
        displayText(privacyPolicyUrl, 'Privacy Policy');
      });
      privacyPolicyLink.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const privacyPolicyUrl = 'https://raw.githubusercontent.com/doubleconnect1/PiMarketMate/main/docs/PrivacyPolicy.txt';
        displayText(privacyPolicyUrl, 'Privacy Policy');
      });
    }
    if (termsOfServiceLink) {
      termsOfServiceLink.addEventListener('click', (e) => {
        e.preventDefault();
        const termsOfServiceUrl = 'https://raw.githubusercontent.com/doubleconnect1/PiMarketMate/main/docs/TermsOfService.txt';
        displayText(termsOfServiceUrl, 'Terms of Service');
      });
      termsOfServiceLink.addEventListener('touchstart', (e) => {
        e.preventDefault();
        const termsOfServiceUrl = 'https://raw.githubusercontent.com/doubleconnect1/PiMarketMate/main/docs/TermsOfService.txt';
        displayText(termsOfServiceUrl, 'Terms of Service');
      });
    }
    if (closeTextBtn) {
      closeTextBtn.addEventListener('click', () => {
        textViewer.style.display = 'none';
        textContent.textContent = '';
        textFallback.classList.add('hidden');
      });
      closeTextBtn.addEventListener('touchstart', () => {
        textViewer.style.display = 'none';
        textContent.textContent = '';
        textFallback.classList.add('hidden');
      });
    }
  </script>
</body>
</html>