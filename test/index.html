<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pi Market Mate - Simple Payment</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    #error-message {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Pi Market Mate</h1>
  <p>Enter amount in Pi and pay:</p>
  <input type="number" id="amount" placeholder="Enter Pi amount" step="0.01" min="0">
  <br>
  <button onclick="initiatePayment()">Pay with Pi</button>
  <div id="error-message"></div>

  <script>
    const sdkUrls = [
      'https://sdk.minepi.com/pi-sdk.js',
      'https://cdn.jsdelivr.net/npm/@pi-network/pi-sdk@1.0.0/dist/pi-sdk.min.js'
    ];
    let sdkLoadAttempts = 0;

    // Load Pi SDK
    async function loadSdk(url) {
      console.log(`Attempting to load SDK from: ${url}`);
      try {
        const script = document.createElement('script');
        script.src = url;
        script.async = true;
        const loadPromise = new Promise((resolve, reject) => {
          script.onload = () => {
            console.log(`SDK loaded successfully from: ${url}`);
            resolve(true);
          };
          script.onerror = () => {
            console.error(`Failed to load SDK from: ${url}`);
            reject(new Error(`Failed to load SDK from ${url}`));
          };
        });
        document.head.appendChild(script);
        await loadPromise;
        return true;
      } catch (error) {
        console.error('SDK load error:', error.message);
        return false;
      }
    }

    // Check if in Pi Browser
    function isPiBrowser() {
      const userAgent = navigator.userAgent.toLowerCase();
      const hostname = window.location.hostname.toLowerCase();
      const isPi = userAgent.includes('pi') || hostname.includes('minepi') || hostname.includes('pimarketmate');
      console.log('Pi Browser check:', { isPi, userAgent, hostname });
      return isPi;
    }

    // Ensure Pi SDK is ready
    async function ensurePiSDKReady() {
      const timeoutMs = 30000;
      const startTime = Date.now();
      while (!window.Pi && (Date.now() - startTime) < timeoutMs) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      if (!window.Pi) {
        console.error('Pi SDK initialization timed out after', timeoutMs, 'ms');
        return false;
      }
      return true;
    }

    // Initialize payment
    async function initiatePayment() {
      const amountInput = document.getElementById('amount');
      const amount = parseFloat(amountInput.value);
      const errorMessage = document.getElementById('error-message');

      errorMessage.textContent = '';
      if (!amount || amount <= 0) {
        errorMessage.textContent = 'Please enter a valid Pi amount.';
        return;
      }

      console.log('Initiating payment:', { amount });
      try {
        if (!isPiBrowser()) {
          console.warn('isPiBrowser returned false, proceeding anyway for testing...');
          // errorMessage.textContent = 'Please open this app in Pi Browser to make a payment.';
          // console.error('Not in Pi Browser');
          // return;
        }

        // Load SDK if not already loaded
        if (!window.Pi) {
          console.warn('window.Pi is undefined, attempting to load SDK...');
          sdkLoadAttempts = 0;
          let sdkLoaded = false;
          for (const url of sdkUrls) {
            sdkLoadAttempts++;
            sdkLoaded = await loadSdk(url);
            if (sdkLoaded) break;
          }
          if (!sdkLoaded || !window.Pi) {
            errorMessage.textContent = 'Pi SDK is not available. Please ensure you\'re in the Pi Browser.';
            console.error('Pi SDK unavailable after', sdkLoadAttempts, 'attempts');
            return;
          }
        }

        console.log('Pi SDK object:', window.Pi);
        console.log('Ensuring Pi SDK is ready...');
        const isReady = await ensurePiSDKReady();
        if (!isReady) {
          errorMessage.textContent = 'Pi SDK failed to initialize. Please try again.';
          console.error('Pi SDK not ready');
          return;
        }

        // Initialize Pi SDK
        console.log('Initializing Pi SDK with appId: marketmate');
        await window.Pi.init({
          version: '1.0',
          sandbox: true,
          appId: 'marketmate'
        }).catch(err => {
          console.error('Pi.init failed:', err.message);
          throw new Error('Pi SDK initialization failed: ' + err.message);
        });

        // Authenticate user
        console.log('Authenticating user...');
        const authResult = await window.Pi.authenticate(
          ['payments'],
          () => console.log('Payment cancelled by user')
        ).catch(err => {
          console.error('Authentication failed:', err.message);
          throw new Error('Authentication failed: ' + err.message);
        });
        console.log('User authenticated:', authResult);

        // Create payment
        console.log(`Creating payment for ${amount} Pi...`);
        const payment = await window.Pi.createPayment({
          amount: amount,
          memo: 'Payment for Pi Market Mate',
          metadata: { orderId: `order_${Date.now()}` }
        }, {
          onReadyForServerApproval: async (paymentId) => {
            console.log('Payment ready for approval:', paymentId);
            try {
              const response = await fetch('/api/payments/approve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId })
              });
              const result = await response.json();
              if (!result.success) {
                throw new Error('Approval failed: ' + (result.error || 'Unknown error'));
              }
              console.log('Payment approved:', result);
            } catch (err) {
              console.error('Approval error:', err.message);
              throw err;
            }
          },
          onReadyForServerCompletion: async (paymentId, txid) => {
            console.log('Payment ready for completion:', paymentId, txid);
            try {
              const response = await fetch('/api/payments/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ paymentId, txid })
              });
              const result = await response.json();
              if (!result.success) {
                throw new Error('Completion failed: ' + (result.error || 'Unknown error'));
              }
              console.log('Payment completed:', result);
            } catch (err) {
              console.error('Completion error:', err.message);
              throw err;
            }
          },
          onCancel: () => {
            console.log('Payment cancelled');
            errorMessage.textContent = 'Payment was cancelled.';
          },
          onError: (err) => {
            console.error('Payment error:', err.message);
            errorMessage.textContent = 'Payment failed: ' + err.message;
          }
        });
        console.log('Payment created:', payment);
        errorMessage.textContent = 'Payment initiated! Check Pi wallet.';
      } catch (error) {
        console.error('Error in initiatePayment:', error.message, error.stack);
        errorMessage.textContent = 'An error occurred: ' + error.message;
      }
    }
  </script>
</body>
</html>